/*
 * Slurm Cluster Configuration
 * Resource allocation for HPC environment with Apptainer
 */

// ================================================================================
// EXECUTOR CONFIGURATION
// ================================================================================

executor {
    name = 'slurm'
    queueSize = 150                     // Max number of jobs in queue (increased for parallel processing)
    submitRateLimit = '20/1min'         // Rate limit for job submission (20 per minute)
    pollInterval = '30 sec'             // How often to check job status
    queueStatInterval = '5 min'         // How often to check queue status
    exitReadTimeout = '30 min'          // Timeout for reading exit status
}

// ================================================================================
// PROCESS RESOURCE ALLOCATION
// ================================================================================

process {
    // ============================================================================
    // DEFAULT RESOURCES
    // ============================================================================
    
    executor = 'slurm'
    
    // Default resources for all processes
    cpus = 8
    memory = '32 GB'
    time = '24h'
    
    // Slurm-specific options
    clusterOptions = '--partition=hpcnirc'
    
    // Queue settings
    queue = 'hpcnirc'
    
    // ============================================================================
    // DICOM TO BIDS CONVERSION
    // ============================================================================
    
    withName: 'DICOM_TO_BIDS' {
        container = params.heudiconv_container
        cpus = 4
        memory = '16 GB'
        time = '4h'
        clusterOptions = '--partition=hpcnirc'
    }
    
    // ============================================================================
    // BIDS VALIDATION
    // ============================================================================
    
    withName: 'BIDS_VALIDATE' {
        container = params.bids_validator_container
        cpus = 2
        memory = '8 GB'
        time = '1h'
        clusterOptions = '--partition=hpcnirc'
    }
    
    // ============================================================================
    // MRIQC PROCESSES
    // ============================================================================
    
    withName: 'MRIQC' {
        container = params.mriqc_container
        cpus = 8
        memory = '32 GB'
        time = '12h'
        clusterOptions = '--partition=hpcnirc'
    }
    
    withName: 'MRIQC_GROUP' {
        container = params.mriqc_container
        cpus = 4
        memory = '16 GB'
        time = '4h'
        clusterOptions = '--partition=hpcnirc'
    }
    
    // ============================================================================
    // FASTSURFER CROSS-SECTIONAL
    // ============================================================================
    
    withName: 'FASTSURFER_CROSS' {
        container = params.container
        cpus = 16
        memory = '64 GB'
        time = '24h'
        clusterOptions = '--partition=hpcnirc'
    }
    
    // ============================================================================
    // FASTSURFER LONGITUDINAL
    // ============================================================================
    
    withName: 'FASTSURFER_LONG_BASE' {
        container = null  // Use host FreeSurfer module instead of container
        cpus = 16
        memory = '96 GB'
        time = '48h'
        clusterOptions = '--partition=hpcnirc'
    }

    withName: 'FASTSURFER_LONG_TP' {
        container = null  // Use host FreeSurfer module instead of container
        cpus = 16
        memory = '64 GB'
        time = '24h'
        clusterOptions = '--partition=hpcnirc'
    }
    
    // ============================================================================
    // ATLAS EXTRACTION
    // ============================================================================
    
    withName: 'EXTRACT_ATLASES' {
        container = params.container
        cpus = 4
        memory = '16 GB'
        time = '4h'
        clusterOptions = '--partition=hpcnirc'
    }
    
    // ============================================================================
    // STATISTICS AGGREGATION
    // ============================================================================
    
    withName: 'AGGREGATE_STATS' {
        container = params.container
        cpus = 2
        memory = '8 GB'
        time = '2h'
        clusterOptions = '--partition=hpcnirc'
    }
    
    withName: 'LONGITUDINAL_STATS' {
        container = params.container
        cpus = 2
        memory = '8 GB'
        time = '2h'
        clusterOptions = '--partition=hpcnirc'
    }
    
    withName: 'AGGREGATE_QC' {
        container = params.mriqc_container
        cpus = 2
        memory = '8 GB'
        time = '2h'
        clusterOptions = '--partition=hpcnirc'
    }
    
    // ============================================================================
    // SUMMARY GENERATION
    // ============================================================================
    
    withName: 'GENERATE_SUMMARY' {
        container = params.container
        cpus = 1
        memory = '4 GB'
        time = '30m'
        clusterOptions = '--partition=hpcnirc'
    }
}

// ================================================================================
// APPTAINER/SINGULARITY CONFIGURATION FOR SLURM
// ================================================================================

apptainer {
    enabled = true
    autoMounts = true
    cacheDir = "${projectDir}/images"
    
    // Bind paths for cluster
    runOptions = """
        -B ${projectDir}:${projectDir} \
        -B /tmp:/tmp
    """.stripIndent().replaceAll('\n', ' ')
}

singularity {
    enabled = false
    autoMounts = true
    cacheDir = "${projectDir}/images"

    // Bind paths for cluster
    runOptions = """
        -B ${projectDir}:${projectDir} \
        -B /tmp:/tmp
    """.stripIndent().replaceAll('\n', ' ')
}

// ================================================================================
// RESOURCE LIMITS
// ================================================================================

// Maximum resource limits (adjust based on your cluster)
process {
    maxCpus = 32
    maxMemory = '256 GB'
    maxTime = '7d'
}

// ================================================================================
// ERROR HANDLING
// ================================================================================

process {
    // Retry with more resources on failure, ignore if it fails after retries
    errorStrategy = { task.exitStatus in [104,134,137,139,140,143,247] ? 'retry' : task.attempt <= 2 ? 'retry' : 'ignore' }
    maxRetries = 3

    // Increase resources on retry
    cpus = { check_max( 8 * task.attempt, 'cpus' ) }
    memory = { check_max( 32.GB * task.attempt, 'memory' ) }
    time = { check_max( 24.h * task.attempt, 'time' ) }
}

// Helper function to check resource limits
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.maxMemory as nextflow.util.MemoryUnit) == 1)
                return params.maxMemory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max memory '${params.maxMemory}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.maxTime as nextflow.util.Duration) == 1)
                return params.maxTime as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max time '${params.maxTime}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.maxCpus as int )
        } catch (all) {
            println "   ### ERROR ###   Max cpus '${params.maxCpus}' is not valid! Using default value: $obj"
            return obj
        }
    }
}
