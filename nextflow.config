/*
 * Main Nextflow Configuration File
 * Comprehensive Neuroimaging Pipeline
 */

// ================================================================================
// MANIFEST
// ================================================================================

manifest {
    name = 'SNIRP-HPC-FreeSurfer-Pipeline'
    author = 'SNIRP Lab'
    description = 'SNIRP HPC neuroimaging pipeline: FastSurfer cross-sectional & longitudinal analysis, multi-atlas parcellation, automated statistics'
    mainScript = 'main.nf'
    version = '2.0.0'
    nextflowVersion = '>=21.04.0'
}

// ================================================================================
// DEFAULT PARAMETERS
// ================================================================================

params {
    // ============================================================================
    // PIPELINE CONTROL
    // ============================================================================
    
    // Stage toggles
    run_dicom_conversion = false        // Convert DICOM to BIDS
    run_bids_validation = true          // Validate BIDS structure
    run_mriqc = false                   // Run MRIQC quality control
    run_longitudinal = false            // Process longitudinal data
    
    // Input mode: 'dicom', 'bids', or 'nii'
    input_mode = 'nii'
    
    // ============================================================================
    // INPUT/OUTPUT DIRECTORIES
    // ============================================================================
    
    // Input directories
    dicom_dir = "${projectDir}/dicom"
    bids_dir = "${projectDir}/bids"
    nii_dir = "${projectDir}/nii"
    
    // Output directories
    output_dir = "${projectDir}/fs_outputs"
    long_output_dir = "${projectDir}/long_outputs"
    qc_dir = "${projectDir}/qc"
    stats_dir = "${projectDir}/stats"
    
    // ============================================================================
    // INPUT PATTERNS
    // ============================================================================
    
    pattern = "*_T1w.nii.gz"            // NIfTI file pattern
    
    // ============================================================================
    // PROCESSING PARAMETERS
    // ============================================================================
    
    // FreeSurfer/FastSurfer
    license = "${projectDir}/fs_license/license.txt"
    threads = 16
    
    // ============================================================================
    // CONTAINER IMAGES
    // ============================================================================
    
    // FastSurfer (local Apptainer image)
    container = "${projectDir}/images/fastsurfer-cpu.sif"
    
    // External containers (will be pulled by Apptainer)
    heudiconv_container = "docker://nipy/heudiconv:1.1.6"
    bids_validator_container = "docker://bids/validator:1.14.0"
    mriqc_container = "docker://nipreps/mriqc:24.0.0"
    
    // ============================================================================
    // ATLAS EXTRACTION OPTIONS
    // ============================================================================
    
    // Standard atlases (always extracted)
    extract_desikan = true              // Desikan-Killiany (aparc)
    extract_destrieux = true            // Destrieux (aparc.a2009s)
    extract_dkt = true                  // DKT atlas
    
    // Advanced atlases (require additional setup)
    extract_schaefer = true             // Schaefer parcellation
    extract_glasser = true              // Glasser multimodal parcellation
    extract_yeo = true                  // Yeo functional networks
    extract_cobra = true                // COBRA hippocampal subfields
    extract_neuromorphometrics = true   // Neuromorphometrics atlas
    
    // Schaefer atlas options
    schaefer_parcels = "100,200,400"    // Comma-separated parcel counts
    schaefer_networks = "7,17"          // Network counts (7 or 17)
    
    // ============================================================================
    // QC PARAMETERS
    // ============================================================================
    
    mriqc_float32 = true                // Use float32 precision in MRIQC
    mriqc_ants_nthreads = 8             // ANTs threads for MRIQC
    
    // ============================================================================
    // HELP
    // ============================================================================
    
    help = false
}

// ================================================================================
// CONTAINER CONFIGURATION
// ================================================================================

// Apptainer/Singularity configuration
apptainer {
    enabled = true
    autoMounts = true
    runOptions = "-B ${projectDir}:${projectDir}"
    cacheDir = "${projectDir}/images"
}

singularity {
    enabled = false
    autoMounts = true
    runOptions = "-B ${projectDir}:${projectDir}"
    cacheDir = "${projectDir}/images"
}

// Docker configuration (for local testing)
docker {
    enabled = false
    runOptions = "-v ${projectDir}:${projectDir}"
}

// ================================================================================
// PROCESS DEFAULTS
// ================================================================================

process {
    // Default container
    container = params.container
    
    // Default executor
    executor = 'slurm'
    
    // Error handling
    errorStrategy = { task.attempt <= 3 ? 'retry' : 'finish' }
    maxRetries = 3
    maxErrors = '-1'
    
    // Scratch directory
    scratch = false
}

// ================================================================================
// EXECUTION REPORTS
// ================================================================================

// Execution report
report {
    enabled = true
    file = "${projectDir}/logs/execution_report.html"
    overwrite = true
}

// Timeline report
timeline {
    enabled = true
    file = "${projectDir}/logs/timeline.html"
    overwrite = true
}

// Trace report
trace {
    enabled = true
    file = "${projectDir}/logs/trace.txt"
    overwrite = true
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

// DAG visualization
dag {
    enabled = true
    file = "${projectDir}/logs/pipeline_dag.html"
    overwrite = true
}

// ================================================================================
// WORK DIRECTORY
// ================================================================================

workDir = "${projectDir}/work"

// ================================================================================
// PROFILES
// ================================================================================

profiles {
    // Slurm profile (default for HPC)
    slurm {
        includeConfig 'conf/slurm.config'
    }
    
    // Local profile (for testing)
    local {
        process.executor = 'local'
        process.cpus = 4
        process.memory = '16 GB'
    }
    
    // Debug profile
    debug {
        process.beforeScript = 'echo $HOSTNAME; echo $PWD; ls -la'
        cleanup = false
    }
    
    // Test profile (minimal resources)
    test {
        params.threads = 2
        process.cpus = 2
        process.memory = '8 GB'
        process.time = '1h'
    }
}

// ================================================================================
// NOTIFICATION
// ================================================================================

notification {
    enabled = false
    to = 'your.email@institution.edu'
}

// ================================================================================
// CLEANUP
// ================================================================================

cleanup = false  // Set to true to automatically clean work directory on success
